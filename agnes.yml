agnes:
  version: 4

config:
  path: .agnes
  repository:
    url: git@github.com:Hilti-Research/submit-agnes
    folder: submit.hilti-challenge.com

build:
  path: .build

github:
  api_token: '%env(GITHUB_API_TOKEN)%'
  repository: Hilti-Research/submit

data:
  shared_folders:
    - var/persistent

  files:
    - path: .env.local
      required: true

scripts:
  build:
    hook: build
    script:
      - 'composer install --verbose --prefer-dist --no-interaction --no-dev --optimize-autoloader --no-scripts'
      - 'npm install'
      - 'npm run build'
      - 'cp public/build/email.*.css public/build/email.css'
      - 'rm -rf node_modules'

  deploy:
    hook: deploy
    script:
      - '{{php}} bin/console cache:clear -n'
      - '{{php}} bin/console doctrine:migrations:migrate -n'

  rollback:
    hook: rollback
    script:
      - 'cd $PREVIOUS_RELEASE_PATH && export MIGRATE_TO=$({{php}} bin/console doctrine:migrations:latest)'
      - '{{php}} bin/console doctrine:migrations:migrate $MIGRATE_TO -n'

tasks:
  copy_prod_to_staging_before_deploy:
    before: deploy
    task: copy
    instance_filter: '*:*:staging'
    arguments: { source: prod }
